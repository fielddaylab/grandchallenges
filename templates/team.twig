<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Grand Challenges</title>
<link rel="stylesheet" type="text/css" href="css/styles.css">
<script type="text/javascript" src="js/zepto.min.js"></script>

<script type="text/javascript">

var community = {% if data.team.community %}
  {{ data.team.community|json_encode()|raw }}
{% else %}
  []
{% endif %};

function makePersonObject() {
  var obj = {
    first_name: $('#community-first-name').val(),
    last_name: $('#community-last-name').val(),
    email: $('#community-email').val(),
    bio: $('#community-bio').val(),
  };
  var empty = [];
  if (!obj.first_name.match(/\S/)) empty.push('first name');
  if (!obj.last_name.match(/\S/)) empty.push('last name');
  if (!obj.email.match(/\S/)) empty.push('email address');
  if (!obj.bio.match(/\S/)) empty.push('team contribution');
  if (empty.length !== 0) {
    alert('Please fill out these missing fields: ' + empty.join(', ') + '.');
    return null;
  }
  $('#community-first-name').val('');
  $('#community-last-name').val('');
  $('#community-email').val('');
  $('#community-bio').val('');
  return obj;
}

function removeCommunity(index) {
  community.splice(index, 1);
  showList();
}

var editing_index = null;

function startEditing(index) {
  var person = community[index];
  if (person == null) return;
  editing_index = index;
  $('#community-first-name').val(person.first_name);
  $('#community-last-name').val(person.last_name);
  $('#community-email').val(person.email);
  $('#community-bio').val(person.bio);
  $('#edit-controls').css('display', 'block');
  $('#community-plus-p').css('display', 'none');
  $('#next-button-p').css('display', 'none');
}

function saveEdit() {
  var obj = makePersonObject();
  if (obj == null) return;
  community[editing_index] = obj;
  showList();
  cancelEdit();
}

function cancelEdit() {
  editing_index = null;
  $('#edit-controls').css('display', 'none');
  $('#community-plus-p').css('display', 'block');
  $('#next-button-p').css('display', 'block');
  $('#community-first-name').val('');
  $('#community-last-name').val('');
  $('#community-email').val('');
  $('#community-bio').val('');
}

function showList() {
  $('#members-list').html((function(){
    var str = '';
    community.forEach(function(com, i){
      str += '<p class="member-entry"><a href="#" class="member-x" onClick="removeCommunity('+i+'); return false;"><img src="img/x.png"></a><span>' + com.last_name + ', ' + com.first_name + ' <a href="#" onClick="startEditing('+i+'); return false;">(edit)</a></span></p>';
    });
    return str;
  })());
}

function saveAndGo(destination) {
  if ($('#community-first-name').val() && $('#community-last-name').val() && $('#community-email').val() && $('#community-bio').val()) {
    // if they forgot to hit the plus, do that
    $('#community-plus').click();
  }
  $('#hidden-json').val(JSON.stringify({
    community: community,
  }));
  if (destination) {
    $('#hidden-redirect').val(destination);
  }
  $('#hidden-form').submit();
}

$(function(){
  showList();
  $('#community-plus').click(function(e){
    e.preventDefault();
    var obj = makePersonObject();
    if (obj == null) return;
    community.push(obj);
    showList();
  });
  $('#next-button').click(function(){
    saveAndGo();
  });
  $('#save-edits').click(function(e){
    e.preventDefault();
    saveEdit();
  });
  $('#cancel-edits').click(function(e){
    e.preventDefault();
    cancelEdit();
  });
});

</script>

</head>
<body>

<form class="hidden-form" id="hidden-form" method="post" action="save-team">
  <input type="text" name="json" id="hidden-json">
  <input type="text" name="redirect" id="hidden-redirect" value="">
</form>

{{ include('nav.twig') }}

<div class="concept-hero">
  <div class="concept-hero-title">
    <h1>Hello {{ netid }}</h1>
    <h2>Welcome to the Grand Challenges</h2>
  </div>
</div>

<div class="concept-tab-bar">
  <a href="." onclick="saveAndGo(); return false;" class="concept-tab-bar-item concept-tab-bar-item-active">
    Dashboard
  </a>
</div>

<div class="concept-columns">
  <div class="concept-column concept-column-left">
    <div class="concept-map-chunk">
      <img src="img/map-pipe.png">
    </div>
    <div class="concept-map-chunk concept-map-current">
      <img src="img/map-checked.png">
      <a href="meeting" onclick="saveAndGo('meeting'); return false;"><span>Meet with Network</span></a>
    </div>
    <div class="concept-map-chunk concept-map-current">
      <img src="img/map-checked.png">
      <a href="bio" onclick="saveAndGo('bio'); return false;"><span>Project Info</span></a>
    </div>
    <div class="concept-map-chunk concept-map-current">
      <img src="img/map-orange.png">
      <a href="team" onclick="saveAndGo('team'); return false;"><span>Your Team</span></a>
    </div>
    <div class="concept-map-chunk">
      <img src="img/map-gray.png">
      <a href="support" onclick="saveAndGo('support'); return false;"><span>Optional Support</span></a>
    </div>
    <div class="concept-map-chunk">
      <img src="img/map-gray-end.png">
      <a href="line" onclick="saveAndGo('line'); return false;"><span>Choose Your Path</span></a>
    </div>
  </div>
  <div style="width: 100%;">
    <div class="concept-columns-nav">
      <a href="bio" onclick="saveAndGo('bio'); return false;">
        <div class="concept-columns-nav-side concept-columns-nav-side-left">
          <img src="img/arrow-gold-left.png">
          <span>Project Info</span>
        </div>
      </a>
      <a href="support" onclick="saveAndGo('support'); return false;">
        <div class="concept-columns-nav-side concept-columns-nav-side-right">
          <span>Optional Support</span>
          <img src="img/arrow-gold-right.png">
        </div>
      </a>
    </div>
    <div class="concept-columns">
      <div class="concept-column concept-column-middle bio-form">
        <h2>
          <img src="img/connect-dot.png">
          Set up your team
        </h2>
        <div class="team-instructions">
          <p>
            Each team must include at least two members of the UW-SOE faculty and/or staff community. If the focus of your Grand Challenge is community impact, please include relevant community partners on your team.
          </p>
        </div>
        <div class="team-halves">
          <div class="big-form-split">
            <p>
              <label>
                First Name<br>
                <input type="text" id="community-first-name">
              </label>
            </p>
            <p>
              <label>
                Last Name<br>
                <input type="text" id="community-last-name">
              </label>
            </p>
          </div>
          <p>
            <label>
              Email<br>
              <input type="text" id="community-email">
            </label>
          </p>
          <p>
            <label>
              What does this person bring to the team? (200 words)<br>
              <textarea id="community-bio"></textarea>
            </label>
          </p>
          <p id="community-plus-p">
            <a href="#" id="community-plus"><img src="img/plus.png"></a>
          </p>
        </div>
        <div id="edit-controls" style="display: none;">
          <p>
            <button class="button-brown button-brown-filled" id="save-edits" type="button">Save this team member</button>
          </p>
          <p>
            <button class="button-brown button-brown-filled" id="cancel-edits" type="button">Cancel changes</button>
          </p>
        </div>
        <p id="next-button-p">
          <button class="button-brown button-brown-filled" id="next-button" type="button">Save and Continue</button>
        </p>
      </div>
      <div class="concept-column concept-column-right">
        <h3>Your team:</h3>
        <div class="big-form-middle-side">
          <p class="member-entry">
            <a class="member-x" onclick="return false;" style="opacity: 0;">
              <img src="img/x.png">
            </a>
            <span>{{ netid }} (You)</span>
          </p>
          <div id="members-list">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{ include('footer.twig') }}

</body>
</html>
